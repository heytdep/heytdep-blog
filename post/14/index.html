<h1
id="rock-paper-scissors-betting-soroban-smart-contract">Rock-Paper-Scissors
Betting Soroban Smart Contract</h1>
<h2 id="high-level-overview">High-level overview</h2>
<p>This contract allows to bet with another user on a rock paper
scissors game. This kind of betting/games design is also something we at
<span class="citation" data-cites="xycloo">@xycloo</span> are interested
in for future small protocols.</p>
<p>This contract allows for two users to play rock papers scissors by
having them submit their moves hashed according the a <a
href="https://github.com/Xycloo/soroban-commit-reveal-contract">commit-reveal
scheme</a>. Once both players have sumbitted their move (without
revealing it since it’s a hash), they can reveal it. Once both moves are
revealed, the contract evaluates the winner using a simple modulo
algorithm.</p>
<p>There are a couple of other things to keep in mind: - the contract
has to be initialized by a game admin, which specifies some settings. -
if a user doesn’t reveal its move after <span
class="math inline"><em>Δ</em><em>t</em></span> (specified upon
initialization) since the second player submitted their move, a user can
call the <code>cancel</code> function, which resets the game and sends
all the betted money to the user who revealed its move (since it
assuments that the other user won’t reveal theirs since they know the
other user has already won).</p>
<h1 id="writing-the-contract">Writing the contract</h1>
<blockquote>
<p>Reading this README assumes that you already have basic soroban
knowledge (if you don’t, I recommend looking at the soroban docs or at
our previous submissions).</p>
</blockquote>
<h2 id="workflow">Workflow</h2>
<p><img
src="https://user-images.githubusercontent.com/70587974/203127840-7bcc14d4-5fb5-40d1-8e4a-b6c95a0e785a.png"
alt="image" /> (done with excalidraw)</p>
<h3 id="some-things-to-know">Some things to know</h3>
<p>In this contract we are going to use: - the standard token contract.
- custom types (some with their own implementations
(<code>TimeStamp</code>, <code>Move</code>, <code>PlayerObj</code>)). -
contract errors (for better failure reports than a string panic). - the
same principles of the <a
href="https://github.com/Xycloo/soroban-commit-reveal-contract">commit-reveal
scheme from one of our previous submissions</a>.</p>
<h3 id="writing-the-data-helpers">Writing the data helpers</h3>
<p>We are going to use some data helper function in our contract
invocation to have a more coincise code inside our contract
functions:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;testutils&quot;</span><span class="at">)]</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">crate</span> std<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> test<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">mod</span> testutils<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">soroban_auth::</span><span class="op">{</span>verify<span class="op">,</span> Identifier<span class="op">,</span> Signature<span class="op">};</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">soroban_sdk::</span><span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    bigint<span class="op">,</span> bytes<span class="op">,</span> contracterror<span class="op">,</span> contractimpl<span class="op">,</span> contracttype<span class="op">,</span> panic_with_error<span class="op">,</span> <span class="pp">serde::</span>Serialize<span class="op">,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    symbol<span class="op">,</span> BigInt<span class="op">,</span> Bytes<span class="op">,</span> BytesN<span class="op">,</span> Env<span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> token <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="pp">soroban_sdk::contractimport!</span>(file <span class="op">=</span> <span class="st">&quot;./soroban_token_spec.wasm&quot;</span>)<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> check_player(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> player<span class="op">:</span> Player) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Player(player)<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>has(key)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> check_revealed(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> player<span class="op">:</span> Player) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> obj <span class="op">=</span> get_move(e<span class="op">,</span> player)<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span><span class="pp">matches!</span>(obj<span class="op">.</span>move_pre<span class="op">,</span> <span class="pp">Move::</span>Unrevealed)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_started(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> started<span class="op">:</span> <span class="dt">bool</span>) <span class="op">{</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Started<span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> started)<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> game_started(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Started<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>get(key)<span class="op">.</span>unwrap_or(<span class="cn">Ok</span>(<span class="cn">false</span>))<span class="op">.</span>unwrap()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> remove_player(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> player<span class="op">:</span> Player) <span class="op">{</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Player(player)<span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>remove(key)<span class="op">;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> store_move(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> player<span class="op">:</span> Player<span class="op">,</span> val<span class="op">:</span> PlayerObj) <span class="op">{</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Player(player)<span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> val)<span class="op">;</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_move(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> player<span class="op">:</span> Player) <span class="op">-&gt;</span> PlayerObj <span class="op">{</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Player(player)<span class="op">;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>get(key)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_nonce(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> id<span class="op">:</span> Identifier) <span class="op">{</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Nonce(id<span class="op">.</span>clone())<span class="op">;</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> get_nonce(e<span class="op">,</span> id) <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_nonce(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> id<span class="op">:</span> Identifier) <span class="op">-&gt;</span> BigInt <span class="op">{</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Nonce(id)<span class="op">;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>get(key)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="cn">Ok</span>(<span class="pp">BigInt::</span>zero(e)))</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_token(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> token<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span>) <span class="op">{</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Token<span class="op">;</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_token(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>Token<span class="op">;</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>get(key)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="pp">panic_with_error!</span>(e<span class="op">,</span> <span class="bu">Error</span><span class="pp">::</span>GameNotStarted))</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_ts_limit(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> ts_diff<span class="op">:</span> TimeStamp) <span class="op">{</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>TsLimit<span class="op">;</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> ts_diff)<span class="op">;</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_ts_limit(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> TimeStamp <span class="op">{</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>TsLimit<span class="op">;</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>get(key)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="pp">panic_with_error!</span>(e<span class="op">,</span> <span class="bu">Error</span><span class="pp">::</span>GameNotStarted))</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_bet_start(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> ts<span class="op">:</span> TimeStamp) <span class="op">{</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>BetStart<span class="op">;</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> ts)<span class="op">;</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_bet_start(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> TimeStamp <span class="op">{</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>BetStart<span class="op">;</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>get(key)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="pp">panic_with_error!</span>(e<span class="op">,</span> <span class="bu">Error</span><span class="pp">::</span>GameNotStarted))</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> put_bet(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> amount<span class="op">:</span> BigInt) <span class="op">{</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>BetAmount<span class="op">;</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()<span class="op">.</span>set(key<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_bet(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> BigInt <span class="op">{</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="pp">DataKey::</span>BetAmount<span class="op">;</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>data()</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>get(key)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="pp">panic_with_error!</span>(e<span class="op">,</span> <span class="bu">Error</span><span class="pp">::</span>GameNotStarted))</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="placing-bets-with-the-standard-token-contract">Placing bets with
the standard token contract</h3>
<p>To transfer from the user to the contract, we are going to use
allowances. Allowances allow the <code>standard_token.xfer_from()</code>
function to transfer from a specified address to another as long as
there is an allowance for that (we could also use the advanced auth and
accept a signature to use the <code>xfer</code> function).</p>
<p>On the other hand, sending profits simmly requires the contract to
transfer to the winning user.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> place_bet(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> from<span class="op">:</span> Identifier) <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> client <span class="op">=</span> <span class="pp">token::Client::</span>new(e<span class="op">,</span> get_token(e))<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>xfer_from(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="pp">Signature::</span>Invoker<span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="pp">BigInt::</span>zero(e)<span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span>from<span class="op">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="pp">Identifier::</span>Contract(e<span class="op">.</span>current_contract())<span class="op">,</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span>get_bet(e)<span class="op">,</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> send_profit(e<span class="op">:</span> <span class="op">&amp;</span>Env<span class="op">,</span> to<span class="op">:</span> Identifier<span class="op">,</span> amount<span class="op">:</span> BigInt) <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> client <span class="op">=</span> <span class="pp">token::Client::</span>new(e<span class="op">,</span> get_token(e))<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>xfer(<span class="op">&amp;</span><span class="pp">Signature::</span>Invoker<span class="op">,</span> <span class="op">&amp;</span><span class="pp">BigInt::</span>zero(e)<span class="op">,</span> <span class="op">&amp;</span>to<span class="op">,</span> <span class="op">&amp;</span>amount)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="timestamp-type">Timestamp type</h3>
<p>To better distinguish timestamps, we create a custom type for them,
and have them implement addition and subtraction functions:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform arithmetic ops on custom types</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Arithmetic<span class="op">&lt;</span>Rhs <span class="op">=</span> <span class="dt">Self</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> Output<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> add(<span class="kw">self</span><span class="op">,</span> rhs<span class="op">:</span> Rhs) <span class="op">-&gt;</span> <span class="dt">Self</span><span class="pp">::</span>Output<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> sub(<span class="kw">self</span><span class="op">,</span> rhs<span class="op">:</span> Rhs) <span class="op">-&gt;</span> <span class="dt">Self</span><span class="pp">::</span>Output<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">PartialOrd</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="bu">Ord</span><span class="op">,</span> <span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">/// Timestamp type to enforce explicitness</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> TimeStamp(<span class="kw">pub</span> <span class="dt">u64</span>)<span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> TimeStamp <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> current(e<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span>(e<span class="op">.</span>ledger()<span class="op">.</span>timestamp())</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Arithmetic<span class="op">&lt;</span>TimeStamp<span class="op">&gt;</span> <span class="cf">for</span> TimeStamp <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> Output <span class="op">=</span> TimeStamp<span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> add(<span class="kw">self</span><span class="op">,</span> other<span class="op">:</span> <span class="dt">Self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span>(<span class="kw">self</span><span class="op">.</span><span class="dv">0</span> <span class="op">+</span> other<span class="op">.</span><span class="dv">0</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> sub(<span class="kw">self</span><span class="op">,</span> other<span class="op">:</span> <span class="dt">Self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span>(<span class="kw">self</span><span class="op">.</span><span class="dv">0</span> <span class="op">-</span> other<span class="op">.</span><span class="dv">0</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="errors">Errors</h3>
<p>Errors in soroban smart contract work similarly to rust’s errors. We
need to define a <code>contracterror</code> type with a u32
representation so that the host can return the errors in the format
<code>ContractError(Error::ThisError as u32)</code>:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracterror<span class="at">]</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Copy</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Debug</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">PartialOrd</span><span class="op">,</span> <span class="bu">Ord</span><span class="at">)]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    GameNotStarted <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    MaxPlayersHit <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    InvalidReveal <span class="op">=</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    InvalidOp <span class="op">=</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    NotRevealed <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    LimitNotReached <span class="op">=</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    InvalidSignature <span class="op">=</span> <span class="dv">7</span><span class="op">,</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You might have seen that we encountered some of these in our data
helpers with <code>panic_with_error</code>. As we write our contract, it
will become clearer what each error means.</p>
<h3 id="other-contract-types">Other contract types</h3>
<p>Below we define other contract types. They should be pretty
self-explanatory, also, we need the <code>as_bytes()</code> method for
the <code>Move</code> so that it can be used for building the hash
(without serializing). <code>user_move</code> in <code>PlayerObj</code>
is the hash of the user’s move commitment, which we’ll look at
later.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Player <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    One<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    Two<span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> GameResult <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    Winner(Player)<span class="op">,</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    Draw<span class="op">,</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="at">)]</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Move <span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    Rock <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    Paper <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    Scissors <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    Unrevealed <span class="op">=</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Move <span class="op">{</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> as_bytes(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> env<span class="op">:</span> <span class="op">&amp;</span>Env) <span class="op">-&gt;</span> Bytes <span class="op">{</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Move::</span>Rock <span class="op">=&gt;</span> <span class="pp">bytes!</span>(env<span class="op">,</span> <span class="dv">0x526f636b</span>)<span class="op">,</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Move::</span>Paper <span class="op">=&gt;</span> <span class="pp">bytes!</span>(env<span class="op">,</span> <span class="dv">0x5061706572</span>)<span class="op">,</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Move::</span>Scissors <span class="op">=&gt;</span> <span class="pp">bytes!</span>(env<span class="op">,</span> <span class="dv">0x53636973736f7273</span>)<span class="op">,</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="pp">panic_with_error!</span>(env<span class="op">,</span> <span class="bu">Error</span><span class="pp">::</span>InvalidOp)<span class="op">,</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> repr(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span><span class="kw">self</span> <span class="kw">as</span> <span class="dt">u32</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> PlayerObj <span class="op">{</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    id<span class="op">:</span> Identifier<span class="op">,</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    user_move<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;,</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    move_pre<span class="op">:</span> Move<span class="op">,</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> PlayerObj <span class="op">{</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(id<span class="op">:</span> Identifier<span class="op">,</span> user_move<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        PlayerObj <span class="op">{</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>            id<span class="op">,</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            user_move<span class="op">,</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>            move_pre<span class="op">:</span> <span class="pp">Move::</span>Unrevealed<span class="op">,</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="contract-data-keys">Contract data keys</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Contract data keys</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> DataKey <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    BetStart<span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    TsLimit<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    Started<span class="op">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    Token<span class="op">,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    BetAmount<span class="op">,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    Nonce(Identifier)<span class="op">,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    Player(Player)<span class="op">,</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="contract-functions">Contract functions</h2>
<div class="sourceCode" id="cb7"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Contract trait</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> RockPaperScissorsTrait <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// leaving this one for possible updates in the future that need a contract initialization</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> initialize(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        e<span class="op">:</span> Env<span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        token<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        bet_amount<span class="op">:</span> BigInt<span class="op">,</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        ts_diff<span class="op">:</span> TimeStamp<span class="op">,</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> make_move(e<span class="op">:</span> Env<span class="op">,</span> sig<span class="op">:</span> Signature<span class="op">,</span> user_move<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> reveal(e<span class="op">:</span> Env<span class="op">,</span> player<span class="op">:</span> Player<span class="op">,</span> user_move<span class="op">:</span> Move<span class="op">,</span> secret<span class="op">:</span> Bytes) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Move<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> evaluate(e<span class="op">:</span> Env) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>GameResult<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> cancel(e<span class="op">:</span> Env) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="initialize">Initialize</h3>
<p>This function is needed to set up the contract by providing some
important settings: - <code>token</code>: the tokenID the contract will
use. - <code>bet_amount</code>: the ammount of <code>token</code> that
users will have to bet in order to enter the game. -
<code>ts_diff</code>: the previously-mentioned <span
class="math inline"><em>Δ</em><em>t</em></span>.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> initialize(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        e<span class="op">:</span> Env<span class="op">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        token<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        bet_amount<span class="op">:</span> BigInt<span class="op">,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        ts_diff<span class="op">:</span> TimeStamp<span class="op">,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>game_started(<span class="op">&amp;</span>e) <span class="op">{</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            put_started(<span class="op">&amp;</span>e<span class="op">,</span> <span class="cn">true</span>)<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            put_token(<span class="op">&amp;</span>e<span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            put_bet(<span class="op">&amp;</span>e<span class="op">,</span> bet_amount)<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            put_ts_limit(<span class="op">&amp;</span>e<span class="op">,</span> ts_diff)<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>GameNotStarted)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="make-move">Make move</h3>
<p>Users can call this function to enter the game. They will need to
provide a signature (to authenticate) and a <code>user_move</code>. The
function first performs the auth check and increases the nonce, then
assings a <code>Player</code> to the user (<code>One</code> if the user
is the first to make the move, <code>Second</code> is they are the
second, else it panics since it means that there already are two
players).</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> make_move(e<span class="op">:</span> Env<span class="op">,</span> sig<span class="op">:</span> Signature<span class="op">,</span> user_move<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>game_started(<span class="op">&amp;</span>e) <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>            <span class="pp">panic!</span>(<span class="st">&quot;game started yet&quot;</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> get_nonce(<span class="op">&amp;</span>e<span class="op">,</span> sig<span class="op">.</span>identifier(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        verify(<span class="op">&amp;</span>e<span class="op">,</span> <span class="op">&amp;</span>sig<span class="op">,</span> <span class="pp">symbol!</span>(<span class="st">&quot;move&quot;</span>)<span class="op">,</span> (<span class="op">&amp;</span>user_move<span class="op">,</span> <span class="op">&amp;</span>nonce))<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        put_nonce(<span class="op">&amp;</span>e<span class="op">,</span> sig<span class="op">.</span>identifier(<span class="op">&amp;</span>e))<span class="op">;</span> <span class="co">// putting the nonce even for the Invoker singature</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> player_obj <span class="op">=</span> <span class="pp">PlayerObj::</span>new(sig<span class="op">.</span>identifier(<span class="op">&amp;</span>e)<span class="op">,</span> user_move)<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>check_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One) <span class="op">{</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            store_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One<span class="op">,</span> player_obj)<span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            place_bet(<span class="op">&amp;</span>e<span class="op">,</span> sig<span class="op">.</span>identifier(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">!</span>check_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two) <span class="op">{</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            store_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two<span class="op">,</span> player_obj)<span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            place_bet(<span class="op">&amp;</span>e<span class="op">,</span> sig<span class="op">.</span>identifier(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            put_bet_start(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">TimeStamp::</span>current(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MaxPlayersHit)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="reveal">Reveal</h3>
<p>Here the user reveals their move to the contract. This happens by
re-creating the <code>user_move</code> supplied in
<code>make_move()</code>. It’s worth noting that no auth checks are
required here since for the invocation to succeed, it still needs the
user’s secret.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> reveal(e<span class="op">:</span> Env<span class="op">,</span> player<span class="op">:</span> Player<span class="op">,</span> user_move<span class="op">:</span> Move<span class="op">,</span> secret<span class="op">:</span> Bytes) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Move<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> player_obj <span class="op">=</span> get_move(<span class="op">&amp;</span>e<span class="op">,</span> player<span class="op">.</span>clone())<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> rhs <span class="op">=</span> <span class="pp">Bytes::</span>new(<span class="op">&amp;</span>e)<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        rhs<span class="op">.</span>append(<span class="op">&amp;</span>player_obj<span class="op">.</span>clone()<span class="op">.</span>id<span class="op">.</span>serialize(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        rhs<span class="op">.</span>append(<span class="op">&amp;</span>user_move<span class="op">.</span>as_bytes(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        rhs<span class="op">.</span>append(<span class="op">&amp;</span>secret)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> rhs_hash <span class="op">=</span> e<span class="op">.</span>compute_hash_sha256(<span class="op">&amp;</span>rhs)<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> player_obj<span class="op">.</span>user_move <span class="op">!=</span> rhs_hash <span class="op">{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidReveal)<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        player_obj<span class="op">.</span>move_pre <span class="op">=</span> user_move<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        store_move(<span class="op">&amp;</span>e<span class="op">,</span> player<span class="op">,</span> player_obj)<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(user_move)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="evaluate">Evaluate</h3>
<p>This funciton can be called by anyone, and it consists of two parts:
1. Checking that both users have revealed their moves. 2. Determine the
winner using a modulo algorithm. This algorithm works by assigning a u32
value to the <code>Move</code> enum, which is why we specified these u32
representations when defining the enum.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> evaluate(e<span class="op">:</span> Env) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>GameResult<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// check that both players have revealed</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One) <span class="op">||</span> <span class="op">!</span>check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two) <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotRevealed)<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> p1_obj <span class="op">=</span> get_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> p2_obj <span class="op">=</span> get_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (p1_obj<span class="op">.</span>move_pre<span class="op">.</span>repr() <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> p2_obj<span class="op">.</span>move_pre<span class="op">.</span>repr() <span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            send_profit(<span class="op">&amp;</span>e<span class="op">,</span> p2_obj<span class="op">.</span>id<span class="op">,</span> get_bet(<span class="op">&amp;</span>e) <span class="op">*</span> <span class="pp">bigint!</span>(<span class="op">&amp;</span>e<span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="pp">GameResult::</span>Winner(<span class="pp">Player::</span>Two))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> p1_obj<span class="op">.</span>move_pre<span class="op">.</span>repr() <span class="op">==</span> p2_obj<span class="op">.</span>move_pre<span class="op">.</span>repr() <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// give back the betted money to both players</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            send_profit(<span class="op">&amp;</span>e<span class="op">,</span> p1_obj<span class="op">.</span>id<span class="op">,</span> get_bet(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            send_profit(<span class="op">&amp;</span>e<span class="op">,</span> p2_obj<span class="op">.</span>id<span class="op">,</span> get_bet(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="pp">GameResult::</span>Draw)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            send_profit(<span class="op">&amp;</span>e<span class="op">,</span> p1_obj<span class="op">.</span>id<span class="op">,</span> get_bet(<span class="op">&amp;</span>e) <span class="op">*</span> <span class="pp">bigint!</span>(<span class="op">&amp;</span>e<span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="pp">GameResult::</span>Winner(<span class="pp">Player::</span>One))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="cancel">Cancel</h3>
<p>This function can also be called by anyone. It prevents the problem
of users not revealing their moves after seeing the competitor’s
revealed move. In fact, if <span
class="math inline"><em>Δ</em><em>t</em></span> has passed since the
second user has made their move, and one of the two users didn’t reveal
their move, the user who revealed the move receives the whole betted
amount:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> cancel(e<span class="op">:</span> Env) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="pp">TimeStamp::</span>current(<span class="op">&amp;</span>e)<span class="op">.</span>sub(get_ts_limit(<span class="op">&amp;</span>e)) <span class="op">&lt;</span> get_bet_start(<span class="op">&amp;</span>e) <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>LimitNotReached)<span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> p_obj<span class="op">:</span> PlayerObj<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One) <span class="op">&amp;&amp;</span> check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two) <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            p_obj <span class="op">=</span> get_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One) <span class="op">&amp;&amp;</span> <span class="op">!</span>check_revealed(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two) <span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            p_obj <span class="op">=</span> get_move(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>LimitNotReached)<span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        send_profit(<span class="op">&amp;</span>e<span class="op">,</span> p_obj<span class="op">.</span>id<span class="op">,</span> get_bet(<span class="op">&amp;</span>e) <span class="op">*</span> <span class="pp">bigint!</span>(<span class="op">&amp;</span>e<span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>One)<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        remove_player(<span class="op">&amp;</span>e<span class="op">,</span> <span class="pp">Player::</span>Two)<span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h1 id="futurenet">Futurenet</h1>
<blockquote>
<p>Why not play the game on futurenet?</p>
</blockquote>
<p>In order to play the game on futurenet you’ll need: 1. A token
contract with at least two users that have a balance (can be any token).
2. A rock-paper-scissors contract (let’s call it RPSC) deployed, and
initialized. 3. An allowance to allow the RPSC to spend <code>n</code>
of <code>$TOKEN</code> where <code>n</code> and <code>$TOKEN</code> are
defined when initializing the RPSC. 4. The hash of your move +
secret.</p>
<p>Once you have all the above, you are ready to play and bet on a rock
paper scissors game on Soroban!</p>
<h3 id="having-the-token-contract">Having the token contract</h3>
<p>I won’t stay on this topic much since it’s not in the scope of this
README, but can follow these steps: 1. create a stellar classic asset,
wrap it using the CLI or the examples in the soroban branch of the
Python-stellar SDK
(https://github.com/StellarCN/py-stellar-base/blob/soroban/examples/soroban_deploy_create_wrapped_token_contract.py
). 2. make sure that you have an account that holds a certain amount of
those tokens, and then import them using the <code>import</code> fn of
the token contract (remember that you have to think in stroops). 3. You
can make sure that the user has imported the balance by using the
<code>balance</code> function of the token contract.</p>
<p>Example:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-classic-wrapping</span> ❯ python3 create.py</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">simulated</span> transaction: footprint=<span class="st">&#39;AAAAAAAAAAMAAAAG03yUs1elnu8w4XZGY/fEp9zBG6YX3YR0xj616FY0t4kAAAADAAAAAwAAAAbTfJSzV6We7zDhdkZj98Sn3MEbphfdhHTGPrXoVjS3iQAAAAQAAAABAAAAAAAAAAEAAAAFAAAABUFkbWluAAAAAAAABtN8lLNXpZ7vMOF2RmP3xKfcwRumF92EdMY+tehWNLeJAAAABAAAAAEAAAAAAAAAAQAAAAUAAAAITWV0YWRhdGE=&#39;</span> cost=Cost<span class="er">(</span><span class="va">cpu_insns</span><span class="op">=</span><span class="st">&#39;99383&#39;</span>, <span class="va">mem_bytes</span><span class="op">=</span><span class="st">&#39;19036&#39;</span><span class="kw">)</span> <span class="va">results</span><span class="op">=</span>[TransactionStatusResult<span class="kw">(</span><span class="va">xdr</span><span class="op">=</span><span class="st">&#39;AAAABAAAAAEAAAAEAAAAINN8lLNXpZ7vMOF2RmP3xKfcwRumF92EdMY+tehWNLeJ&#39;</span><span class="kw">)</span><span class="ex">]</span> error=None latest_ledger=937040</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">setting</span> footprint and signing transaction...</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sent</span> transaction: id=<span class="st">&#39;4973e0b56a27a9063b1b43c6d007920de85205aa15d730b482ba015d1baab2fe&#39;</span> status=<span class="op">&lt;</span>TransactionStatus.PENDING: <span class="st">&#39;pending&#39;</span><span class="op">&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">waiting</span> for transaction to be confirmed...</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">waiting</span> for transaction to be confirmed...</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">transaction</span> status: id=<span class="st">&#39;4973e0b56a27a9063b1b43c6d007920de85205aa15d730b482ba015d1baab2fe&#39;</span> status=<span class="op">&lt;</span>TransactionStatus.SUCCESS: <span class="st">&#39;success&#39;</span><span class="op">&gt;</span> results=[TransactionStatusResult<span class="er">(</span><span class="va">xdr</span><span class="op">=</span><span class="st">&#39;AAAABAAAAAEAAAAEAAAAINN8lLNXpZ7vMOF2RmP3xKfcwRumF92EdMY+tehWNLeJ&#39;</span><span class="kw">)</span><span class="ex">]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">contract</span> id: d37c94b357a59eef30e1764663f7c4a7dcc11ba617dd8474c63eb5e85634b789</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !2 ❯ soroban invoke <span class="dt">\</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--id</span> d37c94b357a59eef30e1764663f7c4a7dcc11ba617dd8474c63eb5e85634b789 <span class="dt">\</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> <span class="va">$MY_SECRET</span> <span class="dt">\</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> import <span class="dt">\</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Invoker&quot;}]}}&#39;</span> <span class="at">--arg</span> 0 <span class="at">--arg</span> 50000000</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="ex">null</span></span></code></pre></div>
<h3 id="deploying-and-initializing-the-contract">Deploying and
initializing the contract</h3>
<p>To deploy the contract, you first have to compile the code:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ cargo +nightly build <span class="dt">\</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--target</span> wasm32-unknown-unknown <span class="dt">\</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--release</span> <span class="dt">\</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">-Z</span> build-std=std,panic_abort <span class="dt">\</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">-Z</span> build-std-features=panic_immediate_abort</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Compiling</span> soroban-rock-paper-scissors-contract v0.0.0 <span class="er">(</span><span class="ex">/home/tommasodeponti/Desktop/soroban-rock-paper-scissors-contract</span><span class="kw">)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Finished</span> release <span class="pp">[</span><span class="ss">optimized</span><span class="pp">]</span> target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">0.67s</span></span></code></pre></div>
<p>Then you can deploy:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban deploy <span class="dt">\</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--wasm</span> target/wasm32-unknown-unknown/release/soroban_rock_paper_scissors_contract.wasm  <span class="at">--secret-key</span> <span class="va">$SECRET</span> <span class="at">--rpc-url</span>  https://future.stellar.kai.run:443/soroban/rpc <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b</span></span></code></pre></div>
<p>Now we have to initialize the contract:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> <span class="va">$SOME_SECRET</span> <span class="dt">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> initialize <span class="dt">\</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;d37c94b357a59eef30e1764663f7c4a7dcc11ba617dd8474c63eb5e85634b789&#39;</span> <span class="at">--arg</span> 10000000 <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;object&quot;:{&quot;u64&quot;:3600}}]}}&#39;</span></span></code></pre></div>
<p>As you can see, we supplied three arguments: the token contract, the
bet amount (in stroops), and the timestamp difference, which is in our
case an hour (3600 seconds) (see previous sections to learn about these
three parameters).</p>
<h3 id="the-allowance">The allowance</h3>
<p>We approve the previously deployed contract to spend 10000000 stroops
of the previously wrapped and imported token:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="dt">\ </span>                                                                                                                   </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--id</span> d37c94b357a59eef30e1764663f7c4a7dcc11ba617dd8474c63eb5e85634b789 <span class="dt">\</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> <span class="va">$SECRET</span> <span class="dt">\</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> approve <span class="dt">\</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Invoker&quot;}]}}&#39;</span> <span class="at">--arg</span> 0 <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Contract&quot;},{&quot;object&quot;:{&quot;bytes&quot;:&quot;7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b&quot;}}]}}&#39;</span> <span class="at">--arg</span> 10000000</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="ex">null</span></span></code></pre></div>
<h3 id="building-the-hash-of-the-move">Building the hash of the
move</h3>
<p>Since users don’t play in real time one against the other, the
contract uses a commitment technique as previously disussed. But how do
we generate the hash for a futurenet account?</p>
<p>You can simply use this test function we created:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_build_hash() <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extern</span> <span class="kw">crate</span> std<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extern</span> <span class="kw">crate</span> hex<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> e<span class="op">:</span> Env <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span>ledger()<span class="op">.</span>set(LedgerInfo <span class="op">{</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dv">1668106305</span><span class="op">,</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        protocol_version<span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        sequence_number<span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        network_passphrase<span class="op">:</span> <span class="st">&quot;Test SDF Future Network ; October 2022&quot;</span><span class="op">.</span>as_bytes()<span class="op">.</span>to_vec()<span class="op">,</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        base_reserve<span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extern</span> <span class="kw">crate</span> stellar_strkey<span class="op">;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> public <span class="op">=</span> <span class="st">&quot;GBZSAPPCSJC7UQNABF7C7PJZSW2S2H3BTKTVWEXB53WPPA6PXP6AYZ62&quot;</span><span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> decoded <span class="op">=</span> <span class="pp">stellar_strkey::StrkeyPublicKeyEd25519::</span>from_string(<span class="op">&amp;</span>public)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>unwrap()</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> serialized_bytes <span class="op">=</span> <span class="pp">Bytes::</span>from_array(</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span>e<span class="op">,</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span>[</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">65</span><span class="op">,</span> <span class="dv">99</span><span class="op">,</span> <span class="dv">99</span><span class="op">,</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            <span class="dv">111</span><span class="op">,</span> <span class="dv">117</span><span class="op">,</span> <span class="dv">110</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">,</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    serialized_bytes<span class="op">.</span>append(<span class="op">&amp;</span><span class="pp">Bytes::</span>from_array(<span class="op">&amp;</span>e<span class="op">,</span> <span class="op">&amp;</span>decoded))<span class="op">;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> admin_make_move_image <span class="op">=</span> <span class="pp">Bytes::</span>new(<span class="op">&amp;</span>e)<span class="op">;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    admin_make_move_image<span class="op">.</span>append(<span class="op">&amp;</span>serialized_bytes)<span class="op">;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    admin_make_move_image<span class="op">.</span>append(<span class="op">&amp;</span><span class="pp">Move::</span>Scissors<span class="op">.</span>as_bytes(<span class="op">&amp;</span>e))<span class="op">;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    admin_make_move_image<span class="op">.</span>append(<span class="op">&amp;</span><span class="pp">Bytes::</span>from_slice(<span class="op">&amp;</span>e<span class="op">,</span> <span class="st">&quot;mysecret1&quot;</span><span class="op">.</span>as_bytes()))<span class="op">;</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> val <span class="op">=</span> e<span class="op">.</span>compute_hash_sha256(<span class="op">&amp;</span>admin_make_move_image)<span class="op">;</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="pp">std::println!</span>(<span class="st">&quot;{:?}&quot;</span><span class="op">,</span> <span class="pp">hex::</span>encode(val<span class="op">.</span>to_array()))<span class="op">;</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As you can see, you just need to put in your public key, then your
move (in this case <code>Move::Scissors</code> as bytes), and then a
secret which you should not share until you reveal your move.</p>
<p>This will return you a hash in hex format.</p>
<h2 id="playing">Playing</h2>
<p>Now that you have everything set up (remember to repeat steps 3 and 4
(allowance and buillding move hash) for another user), you can invoke
the <code>make_move</code> fn of the contract:</p>
<h3 id="making-the-move">Making the move</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\ </span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--secret-key</span> <span class="va">$U1_SECRET</span> <span class="dt">\</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> make_move <span class="dt">\</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Invoker&quot;}]}}&#39;</span> <span class="at">--arg</span> <span class="st">&quot;</span><span class="va">$U1_MOVE_HASH</span><span class="st">&quot;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ex">null</span></span></code></pre></div>
<p>Then you’ll have to wait until a second player makes the move:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\ </span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">--secret-key</span> <span class="va">$U2_SECRET</span> <span class="dt">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> make_move <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Invoker&quot;}]}}&#39;</span> <span class="at">--arg</span> <span class="st">&quot;</span><span class="va">$U2_MOVE_HASH</span><span class="st">&quot;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">null</span></span></code></pre></div>
<h3 id="revealing">Revealing</h3>
<p>Now each player (u1 as player one since they made the move first, and
u2 as player two) has to reveal their move so that the contract can
evaluate who the winner is and send them the rewards.</p>
<p>U1 reveal (remember that the invoker here doesn’t matter, there just
needs to be the secret as hex):</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="dt">\</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> <span class="va">$SOME_SECRET</span> <span class="dt">\</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> reveal <span class="dt">\</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;One&quot;}]}}&#39;</span> <span class="at">--arg</span> <span class="st">&#39;{&quot;u32&quot;:0}&#39;</span> <span class="at">--arg</span> <span class="st">&quot;6d79736563726574&quot;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span></span></code></pre></div>
<p>Note that we are invoking for <code>Player::One</code> (U1), that we
are passing <code>Move::Rock = 0</code> as a u32 object, and that the
last parameter is the hex encoding of U1’s secret
(<code>"mysecret"</code>).</p>
<p>Now invoking for U2 (<code>Player::Two</code>) with their move
(<code>Move::Scissors</code>), and their secret as hex
(<code>"mysecret1"</code>):</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="dt">\</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> <span class="va">$SOME_SECRET</span> <span class="dt">\</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> reveal <span class="dt">\</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--arg</span> <span class="st">&#39;{&quot;object&quot;:{&quot;vec&quot;:[{&quot;symbol&quot;:&quot;Two&quot;}]}}&#39;</span> <span class="at">--arg</span> <span class="st">&#39;{&quot;u32&quot;:2}&#39;</span> <span class="at">--arg</span> <span class="st">&quot;6d7973656372657431&quot;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span></code></pre></div>
<p>You can see that both these function if all the provided parameters
are correct will return the u32 representation of the <code>Move</code>
enum:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contracttype<span class="at">]</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="at">)]</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Move <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    Rock <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    Paper <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    Scissors <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    Unrevealed <span class="op">=</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now that both players have revealed we can call the
<code>evaluate</code> fn to evaluate the winner and have they receive
the bet profit:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Desktop/soroban-rock-paper-scissors-contract</span> main !3 ❯ soroban invoke <span class="dt">\</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--id</span> 7236cd5d2607a1a9a3950942a66c2b229afbea5ce2d29714af75f18bf993cb7b <span class="dt">\</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--secret-key</span> SB3YZR6KMXEOEWAMS4HUQX4JTWW6METEP3LAXSH2F3GQQT4LOYCR3A44 <span class="dt">\</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--rpc-url</span> https://future.stellar.kai.run:443/soroban/rpc <span class="dt">\</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network-passphrase</span> <span class="st">&#39;Test SDF Future Network ; October 2022&#39;</span> <span class="dt">\</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fn</span> evaluate</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ex">success</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&quot;Winner&quot;</span><span class="ex">,[</span><span class="st">&quot;One&quot;</span><span class="ex">]]</span></span></code></pre></div>
<p>You can see that the winner is indeed U1 who played
<code>Move::Rock</code> against <code>Move::Scissors</code>. U1 now has
<code>10</code> <code>$TOKEN</code> more and U2 <code>10</code>
<code>$TOKEN</code> less!</p>
